-- Verificar estado inicial
SELECT 
    cmk.name AS MasterKey,
    cek.name AS ColumnKey,
    COUNT(*) as ValueCount
FROM sys.column_master_keys cmk
JOIN sys.column_encryption_key_values cekv ON cmk.column_master_key_id = cekv.column_master_key_id
JOIN sys.column_encryption_keys cek ON cekv.column_encryption_key_id = cek.column_encryption_key_id
WHERE cmk.name = 'CMK_Auto2'
GROUP BY cmk.name, cek.name;

---


SELECT 
    cek.name AS ColumnKey,
    COUNT(*) as ValueCount,
    STRING_AGG(cmk.name, ', ') AS MasterKeys
FROM sys.column_encryption_keys cek
JOIN sys.column_encryption_key_values cekv ON cek.column_encryption_key_id = cekv.column_encryption_key_id
JOIN sys.column_master_keys cmk ON cekv.column_master_key_id = cmk.column_master_key_id
WHERE cek.name = 'CEK_Auto2'
GROUP BY cek.name;


----


-- Si queda valor duplicado, limpiar manualmente
ALTER COLUMN ENCRYPTION KEY [CEK_Auto2] 
DROP VALUE (COLUMN_MASTER_KEY = [CMK_Auto2]);

--

SELECT GETDATE() as CheckTime, 
       COUNT(*) as CEK_ValueCount
FROM sys.column_encryption_key_values cekv
JOIN sys.column_encryption_keys cek ON cekv.column_encryption_key_id = cek.column_encryption_key_id
WHERE cek.name = 'CEK_Auto2';
