-- Verificar estado inicial
SELECT 
    cmk.name AS MasterKey,
    cek.name AS ColumnKey,
    COUNT(*) as ValueCount
FROM sys.column_master_keys cmk
JOIN sys.column_encryption_key_values cekv ON cmk.column_master_key_id = cekv.column_master_key_id
JOIN sys.column_encryption_keys cek ON cekv.column_encryption_key_id = cek.column_encryption_key_id
WHERE cmk.name = 'CMK_Auto2'
GROUP BY cmk.name, cek.name;

---


SELECT 
    cek.name AS ColumnKey,
    COUNT(*) as ValueCount,
    STRING_AGG(cmk.name, ', ') AS MasterKeys
FROM sys.column_encryption_keys cek
JOIN sys.column_encryption_key_values cekv ON cek.column_encryption_key_id = cekv.column_encryption_key_id
JOIN sys.column_master_keys cmk ON cekv.column_master_key_id = cmk.column_master_key_id
WHERE cek.name = 'CEK_Auto2'
GROUP BY cek.name;


----


-- Si queda valor duplicado, limpiar manualmente
ALTER COLUMN ENCRYPTION KEY [CEK_Auto2] 
DROP VALUE (COLUMN_MASTER_KEY = [CMK_Auto2]);

--

SELECT GETDATE() as CheckTime, 
       COUNT(*) as CEK_ValueCount
FROM sys.column_encryption_key_values cekv
JOIN sys.column_encryption_keys cek ON cekv.column_encryption_key_id = cek.column_encryption_key_id
WHERE cek.name = 'CEK_Auto2';
--

----
ERROR
-----


SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    CHARACTER_MAXIMUM_LENGTH,
    IS_NULLABLE,
    NUMERIC_PRECISION,
    NUMERIC_SCALE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'ntlc_functional_audit' 
    AND TABLE_NAME = 'TB_FUNCTIONAL_AUDIT' 
    AND COLUMN_NAME = 'CD_USER';


--

SELECT 
    t.name AS TableName,
    c.name AS ColumnName,
    cek.name AS CurrentCEK,
    c.encryption_type_desc,
    c.encryption_algorithm_name
FROM sys.tables t
    JOIN sys.columns c ON t.object_id = c.object_id
    JOIN sys.column_encryption_keys cek ON c.column_encryption_key_id = cek.column_encryption_key_id
WHERE t.name = 'TB_FUNCTIONAL_AUDIT' 
    AND SCHEMA_NAME(t.schema_id) = 'ntlc_functional_audit'
    AND c.name = 'CD_USER';
