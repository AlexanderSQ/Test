--- PARA LA CMK
SELECT DISTINCT
    s.name AS EsquemaTabla,
    t.name AS NombreTabla,
    cek.name AS NombreCEK
FROM 
    sys.column_master_keys cmk
    INNER JOIN sys.column_encryption_key_values cekv 
        ON cmk.column_master_key_id = cekv.column_master_key_id
    INNER JOIN sys.column_encryption_keys cek 
        ON cekv.column_encryption_key_id = cek.column_encryption_key_id
    INNER JOIN sys.columns c 
        ON c.column_encryption_key_id = cek.column_encryption_key_id
    INNER JOIN sys.tables t 
        ON c.object_id = t.object_id
    INNER JOIN sys.schemas s 
        ON t.schema_id = s.schema_id
WHERE 
    cmk.name = 'CMK_Auto1'
ORDER BY 
    s.name, t.name, cek.name;

--- PARA LA CEK:
SELECT DISTINCT
    s.name AS EsquemaTabla,
    t.name AS NombreTabla,
    c.name AS NombreColumna,
    TYPE_NAME(c.user_type_id) AS TipoDato
FROM 
    sys.column_encryption_keys cek
    INNER JOIN sys.columns c 
        ON c.column_encryption_key_id = cek.column_encryption_key_id
    INNER JOIN sys.tables t 
        ON c.object_id = t.object_id
    INNER JOIN sys.schemas s 
        ON t.schema_id = s.schema_id
WHERE 
    cek.name = 'CEK_Auto1'
ORDER BY 
    s.name, t.name, c.name;


--Azure

# Reemplaza con tu Key Vault real
$vaultName = "miempresa-keyvault-prod"
$cutoffDate = (Get-Date).AddYears(-5)
$keys = Get-AzKeyVaultKey -VaultName $vaultName

$oldKeys = $keys | Where-Object { 
    $_.Created -lt $cutoffDate -or $_.Updated -lt $cutoffDate 
} | Select-Object Name, Created, Updated, Enabled

$oldKeys | Export-Csv "keys-antiguas.csv" -NoTypeInformation

# Ver resultados en pantalla
$oldKeys
